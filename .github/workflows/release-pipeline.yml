name: MLOps Production Pipeline
on:
  push:
    branches: [ "testing" ]

permissions:
  id-token: write  # Requerido para OIDC (Login sin contraseñas)
  contents: read

env:
  RG: "ml-prod-rg"
  WS: "mlprod98355597mlws"

jobs:
  train-register-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout del código
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Login en Azure (Recomendamos usar OIDC Federated Credentials)
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}

      # 3. Instalar la extensión de ML para el CLI
      - name: Install ML Extension
        run: az extension add -n ml -y

      # ---------------------------------------------------------
      # PASO A: ENTRENAMIENTO
      # Lanzamos el job y capturamos el ID del Run (Run ID)
      # ---------------------------------------------------------
      - name: Submit Training Job
        id: train_job
        run: |
          # run_id=$(az ml job create --file mlops/job.yml --resource-group $RG --workspace-name $WS --query name -o tsv)
          run_id=$(az ml job create --file pl_ml_deploy_model.yml --resource-group $RG --workspace-name $WS --query name -o tsv)
      
          echo "Job submitted with ID: $run_id"
          
          # Exportamos el ID para que los pasos de Registro y Despliegue lo usen
          # Esperar a que termine (stream logs)
          az ml job stream --name $run_id --resource-group $RG --workspace-name $WS
          
          # Guardar el ID como output para el siguiente paso
          echo "RUN_ID=$run_id" >> $GITHUB_OUTPUT
          echo "Ejecución de entrenamiento iniciada con ID: $run_id"
          

      # ---------------------------------------------------------
      # PASO B: REGISTRO DEL MODELO
      # Registramos el modelo apuntando directamente a los artifacts del Job
      # ---------------------------------------------------------
      - name: Register Model
        id: register_model
        run: |
          # Usamos la sintaxis 'azureml://jobs/{id}/outputs/artifacts/...'
          # model_path="azureml://jobs/${{ steps.train_job.outputs.RUN_ID }}/outputs/artifacts/paths/model"
          MODEL_PATH="azureml://jobs/${{ steps.train_job.outputs.RUN_ID }}/outputs/output_model_continuidad_horario_datastore/paths/model"
          
          # Registramos el modelo en el Workspace
          az ml model create --name "modelo_continuidad_horario" \
                             --path $MODEL_PATH \
                             --type custom_model \
                             --resource-group $RG \
                             --workspace-name $WS
          
          echo "Modelo registrado con la versión más reciente."


      # ---------------------------------------------------------
      # PASO C: DESPLIEGUE (DEPLOYMENT)
      # Actualizamos el deployment 'blue' con el modelo recién registrado
      # ---------------------------------------------------------
      - name: Deploy to Endpoint
        run: |
          # 1. Definición de Variables
          ENDPOINT_NAME="mi-endpoint-universidad"
          DEPLOYMENT_NAME="blue-deployment"
          MODEL_ID="modelo_continuidad_horario@latest"
          VM_SIZE="Standard_DS2_v2" 

          echo "Paso 1: Verificando/Creando el Endpoint..."
          # Si el endpoint no existe, se crea primero (es el contenedor)
          az ml online-endpoint show --name $ENDPOINT_NAME --resource-group $RG --workspace-name $WS || \
          az ml online-endpoint create --name $ENDPOINT_NAME --resource-group $RG --workspace-name $WS

          echo "Paso 2: Generando archivo de configuración temporal..."
          # Creamos el YAML que Azure necesita para evitar el error de 'unrecognized arguments'
          cat <<EOF > deploy_config.yml
          name: $DEPLOYMENT_NAME
          endpoint_name: $ENDPOINT_NAME
          model: azureml:$MODEL_ID
          instance_type: $VM_SIZE
          instance_count: 1
          EOF

          echo "Paso 3: Ejecutando el despliegue..."
          # Intentamos CREAR primero. Si ya existe, fallará y pasará al UPDATE.
          # Usamos --file para cumplir con el requisito de Azure CLI v2
          az ml online-deployment create --file deploy_config.yml --resource-group $RG --workspace-name $WS --all-traffic || \
          (echo "El despliegue ya existe. Actualizando con el nuevo modelo..." && \
           az ml online-deployment update --file deploy_config.yml --resource-group $RG --workspace-name $WS)

          echo "Proceso finalizado correctamente." 

                          