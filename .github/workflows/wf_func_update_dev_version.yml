name: Update Version File

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      platinum_version:
        required: true
        type: string
      feats_version:
        required: true
        type: string
      target_version:
        required: true
        type: string
      model_version:
        required: true
        type: string

permissions:
  contents: write

jobs:
  update-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Update version.json
        run: |
          # Update dev versions with the new versions
          jq '.platinum_version.dev = "${{ inputs.platinum_version }}"' version.json > tmp.json && mv tmp.json version.json
          jq '.feats_version.dev = "${{ inputs.feats_version }}"' version.json > tmp.json && mv tmp.json version.json
          jq '.target_version.dev = "${{ inputs.target_version }}"' version.json > tmp.json && mv tmp.json version.json
          jq '.model_version.dev = "${{ inputs.model_version }}"' version.json > tmp.json && mv tmp.json version.json
          
          echo "Updated version.json with new dev versions:"
          cat version.json

      - name: Commit and push changes
        run: |
          if [[ -n $(git status --porcelain version.json) ]]; then
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            
            # -----------------------------------------------------------------------------------
            # Determine the branch name. 
            # In a PR, head_ref is the source branch. In a push, ref_name is the branch.
            BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
            
            git add version.json
            git commit -m "Update dev versions: platinum=${{ inputs.platinum_version }}, feats=${{ inputs.feats_version }}, target=${{ inputs.target_version }}, model=${{ inputs.model_version }}"
            
            git pull --rebase origin $BRANCH_NAME
            git push origin HEAD:$BRANCH_NAME
          else
            echo "No changes detected in version.json. Skipping commit."
          fi
